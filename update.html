<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Update Profile â€” TrustyTown</title>
  <link rel="stylesheet" href="update.css">
</head>
<body>

  <!-- Header -->
  <div class="header">
    <h1>TrustyTown</h1>
    <h4>Your Local service finder app ðŸ”Ž</h4>
  </div>

  <!-- NAVBAR -->
  <div class="navbar">
    <h1>Welcome!</h1>
    <ul>
      <li><a href="index.html">Home</a></li><p>|</p>
      <li><a href="about.html">About</a></li><p>|</p>
      <li><a href="contact.html">Contact Us</a></li><p>|</p>
      <li><a href="profile.html">Profile</a></li><p>|</p>
      <li><a href="register.html">Register</a></li>
    </ul>
  </div>


    <!--UPDATE FORM-->
  <div class="profile-container" style="max-width:700px;margin:40px auto;">
    <h2 style="text-align:center">Update Your Details</h2>

    <form id="updateForm">
      <input type="hidden" id="originalPhone" />

      <label>Name</label>
      <input id="name" type="text" required />

      <label>Date of birth</label>
      <input id="dob" type="date" required />

      <label>Age</label>
      <input type="number" id="age" name="age" readonly>


      <label>Gender</label>
      <select id="gender" required>
        <option value="">Select</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>

      <label>District</label>
      <input id="district" type="text" required />

      <label>Phone</label>
      <input id="phone" type="tel" required pattern="[0-9]{10}" />

      <label>Email</label>
      <input id="email" type="email" />

      <label>Address</label>
      <input id="address" type="text" required />

      <label>Pincode</label>
      <input id="pincode" type="text" pattern="[0-9]{6}" required />

      <label>New Password (leave blank to keep current)</label>
      <input id="password" type="password" />

      <label>Confirm Current Password (required)</label>
      <input id="confirmPassword" type="password" required />

      <div style="display:flex;gap:12px;margin-top:14px">
        <button id="saveBtn" type="submit" style="flex:1">Save changes</button>
        <button id="cancelBtn" type="button" style="flex:1">Cancel</button>
      </div>
    </form>
  </div>

<script>
  // Cancel button
  document.getElementById('cancelBtn').addEventListener('click', () => {
    location.href = 'profile.html';
  });

  function calculateAge(dob) {
    const birthDate = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    return age;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const savedProfile = localStorage.getItem("userProfile");
    if (!savedProfile) return;
    const userData = JSON.parse(savedProfile);

    // Fill fields
    document.getElementById("name").value = userData.name || "";
    document.getElementById("email").value = userData.email || "";
    document.getElementById("phone").value = userData.phone || "";
    document.getElementById("dob").value = userData.dob || "";
    document.getElementById("age").value = userData.dob ? calculateAge(userData.dob) : "";
    document.getElementById("district").value = userData.district || "";
    document.getElementById("address").value = userData.address || "";
    document.getElementById("pincode").value = userData.pincode || "";
    document.getElementById("gender").value = userData.gender || "";

    // Update age when DOB changes
    document.getElementById("dob").addEventListener("input", function() {
      document.getElementById("age").value = calculateAge(this.value);
    });
  });

  // âœ… Handle form submission
  document.getElementById("updateForm").addEventListener("submit", function(e) {
    e.preventDefault(); // Stop normal form submit

    const savedProfile = JSON.parse(localStorage.getItem("userProfile")) || {};

    const confirmPassword = document.getElementById("confirmPassword").value;
    if (confirmPassword !== savedProfile.password) {
      alert("Current password is incorrect!");
      return;
    }

    // Update object
    savedProfile.name = document.getElementById("name").value;
    savedProfile.email = document.getElementById("email").value;
    savedProfile.phone = document.getElementById("phone").value;
    savedProfile.dob = document.getElementById("dob").value;
    savedProfile.age = document.getElementById("age").value;
    savedProfile.gender = document.getElementById("gender").value;
    savedProfile.district = document.getElementById("district").value;
    savedProfile.address = document.getElementById("address").value;
    savedProfile.pincode = document.getElementById("pincode").value;

    const newPassword = document.getElementById("password").value;
    if (newPassword.trim() !== "") {
      savedProfile.password = newPassword; // change password if entered
    }

    // Save updated profile to localStorage
    localStorage.setItem("userProfile", JSON.stringify(savedProfile));

    alert("Profile updated successfully!");
    location.href = "profile.html"; // Redirect back
  });

document.addEventListener("DOMContentLoaded", () => {
    const storedUser = JSON.parse(localStorage.getItem("loggedInUser"));
    if (storedUser) {
        document.getElementById("phone").value = storedUser.phone;
        document.getElementById("name").value = storedUser.name;
        document.getElementById("email").value = storedUser.email;
        document.getElementById("dob").value = storedUser.dob;
        document.getElementById("age").value = storedUser.age;
        document.getElementById("gender").value = storedUser.gender;
        document.getElementById("district").value = storedUser.district;
        document.getElementById("address").value = storedUser.address;
        document.getElementById("pincode").value = storedUser.pincode;
    }
});

document.getElementById("updateForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const formData = {
        phone: document.getElementById("phone").value,
        name: document.getElementById("name").value,
        email: document.getElementById("email").value,
        dob: document.getElementById("dob").value,
        age: document.getElementById("age").value,
        gender: document.getElementById("gender").value,
        district: document.getElementById("district").value,
        address: document.getElementById("address").value,
        pincode: document.getElementById("pincode").value,
        password: document.getElementById("password").value,
        newPassword: document.getElementById("newPassword").value
    };

    const res = await fetch("/update-profile", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
    });

    const data = await res.json();
    alert(data.message || data.error);

    if (data.user) {
        localStorage.setItem("loggedInUser", JSON.stringify(data.user));
    }
});

</script>


</body>
</html>
