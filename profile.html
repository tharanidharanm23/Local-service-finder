<!DOCTYPE html>
<html>
<head>
  <link rel="icon" href="img/shake_hands.jpeg">
  <link rel="stylesheet" href="profile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <title>TrustyTown</title>
</head>
<body>

  <div class="header">
    <h1>TrustyTown</h1>
    <h4>Your Local service finder app üîé</h4>
  </div>

<div class="navbar">
  <h1>Welcome!</h1>
  <ul>
    <li><a href="index.html">Home</a></li><p>|</p>
    <li><a href="about.html">About</a></li><p>|</p>
    <li><a href="contact.html">Contact Us</a></li><p>|</p>
    <li><a href="profile.html" class="active">Profile</a></li><p>|</p>
    <li><a href="register.html">Register</a></li>
  </ul>
</div>

<div class="profile-container">
  <div class="profile-details">
    <h2>Welcome, <span id="user-name">User</span> üëã</h2>
    <ul id="profile-details"></ul>

    <div class="switch-row">
      <span id="avail-label">Rest</span>
      <label class="switch" aria-label="Toggle work availability">
        <input type="checkbox" id="avail-toggle">
        <span class="slider"></span>
      </label>
    </div>

    <div id="work-box" class="work-box" style="display:none;">
      <h3>Your Work</h3>
      <ul id="work-details"></ul>
    </div>
    <div id="no-work-msg" style="display:none; color:#777; margin-top:10px;">
      No work added yet. Click <strong>+ Add Work</strong> to get started.
    </div>
  </div>
</div>

<div class="center-btn">
  <button id="add-work-btn" aria-label="Add work details">+ Add Work</button>
  <button id="update-btn" aria-label="Update profile details">Update Details</button>
  <button id="logout-btn" aria-label="Logout from your account">Logout</button>
  <button id="delete-btn" aria-label="Delete your account">Delete Account</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("userProfile"));
  if (!user) {
    alert("Please log in or register first!");
    location.href = "login.html";
    return;
  }

  document.getElementById("user-name").textContent = user.name ?? "User";
  document.getElementById("profile-details").innerHTML = `
    <li><strong>Age:</strong> ${user.age ?? "-"}</li>
    <li><strong>Gender:</strong> ${user.gender ?? "-"}</li>
    <li><strong>District:</strong> ${user.district ?? "-"}</li>
    <li><strong>Phone:</strong> ${user.phone ?? "-"}</li>
    <li><strong>Email:</strong> ${user.email ?? "-"}</li>
    <li><strong>Address:</strong> ${user.address ?? "-"}</li>
    <li><strong>Pincode:</strong> ${user.pincode ?? "-"}</li>
    <li><strong>Date of Birth:</strong> ${user.dob ?? "-"}</li>
  `;

  const work = JSON.parse(localStorage.getItem("workProfile"));
  const hasWork = !!(work && work.work);
  const workBox = document.getElementById("work-box");
  const workDetails = document.getElementById("work-details");

  if (hasWork) {
    workBox.style.display = "block";
    workDetails.innerHTML = `
      <li><strong>Work:</strong> ${work.work}</li>
      <li><strong>Years of Experience:</strong> ${work.exp}</li>
      <li><strong>Rating:</strong> ${work.rating ?? 0} ‚≠ê</li>
    `;
  }

  const toggle = document.getElementById("avail-toggle");
  const label = document.getElementById("avail-label");

  if (hasWork) {
    const saved = JSON.parse(localStorage.getItem("workAvail")) || false;
    toggle.disabled = false;
    toggle.checked = saved;
    updateLabel(saved);
  } else {
    toggle.disabled = true;
    label.textContent = "Add a work to enable this button";
    label.style.color = "#dc3545";
  }

  toggle.addEventListener("change", () => {
    if (toggle.disabled) return;
    const state = toggle.checked;
    updateLabel(state);
    localStorage.setItem("workAvail", JSON.stringify(state));
  });

  function updateLabel(on) {
    label.textContent = on ? "Available to work" : "Rest";
    label.style.color = on ? "#28a745" : "#dc3545";
  }

  document.getElementById("logout-btn").addEventListener("click", () => {
    localStorage.clear();
    location.href = "login.html";
  });

  document.getElementById("delete-btn").addEventListener("click", async () => {
    const input = prompt("To delete your account, enter your password:");
    if (input !== user.password) {
      alert("Incorrect password. Account not deleted.");
      return;
    }
    try {
      const res = await fetch("http://localhost:5000/delete-account", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone: user.phone, password: input })
      });
      const result = await res.json();
      if (res.ok) {
        alert(result.message || "Account deleted.");
        localStorage.clear();
        location.href = "register.html";
      } else {
        alert(result.error || "Deletion failed.");
      }
    } catch (err) {
      alert("Server error. Try again later.");
    }
  });


// ‚úÖ Update button redirect (uses userProfile instead of loggedInPhone)
document.getElementById("update-btn").addEventListener("click", function () {
    const user = JSON.parse(localStorage.getItem("userProfile"));
    if (!user) {
        alert("Please log in first.");
        location.href = "login.html";
        return;
    }
    window.location.href = "update.html"; // no need for ?phone
});

});
</script>

</body>
</html>
