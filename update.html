<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Update Profile â€” TrustyTown</title>
  <link rel="stylesheet" href="update.css">
  <style>

  </style>
</head>
<body>
  <div class="header">
    <h1>TrustyTown</h1>
    <h4>Your Local service finder app ðŸ”Ž</h4>
  </div>

  <div class="navbar">
    <ul>
      <li><a href="index.html">Home</a></li><p>|</p>
      <li><a href="about.html">About</a></li><p>|</p>
      <li><a href="contact.html">Contact Us</a></li><p>|</p>
      <li><a href="profile.html">Profile</a></li><p>|</p>
      <li><a href="register.html">Register</a></li>
    </ul>
  </div>

  <div class="profile-container" style="max-width:700px;margin:40px auto;">
    <h2 style="text-align:center">Update Your Details</h2>

    <form id="updateForm">
      <label>Name</label>
      <input id="name" type="text" required>

      <label>Date of Birth</label>
      <input id="dob" type="date" required>

      <label>Age</label>
      <input id="age" type="number" readonly>

      <label>Gender</label>
      <select id="gender" required>
        <option value="">Select</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>

      <label>District</label>
      <input id="district" type="text" required>

      <label>Phone</label>
      <input id="phone" type="tel" required pattern="[0-9]{10}" readonly>

      <label>Email</label>
      <input id="email" type="email">

      <label>Address</label>
      <input id="address" type="text" required>

      <label>Pincode</label>
      <input id="pincode" type="text" pattern="[0-9]{6}" required>

      <label>New Password (leave blank to keep current)</label>
      <input id="newPassword" type="password">

      <label>Confirm Current Password</label>
      <input id="currentPassword" type="password" required>

      <div style="display:flex;gap:12px;margin-top:14px">
        <button type="submit" style="flex:1">Save changes</button>
        <button type="button" id="cancelBtn" style="flex:1">Cancel</button>
      </div>
    </form>
  </div>

  <div id="toast" class="toast"></div>

<script>
function calculateAge(dob) {
  const birthDate = new Date(dob);
  const today = new Date();
  let age = today.getFullYear() - birthDate.getFullYear();
  const m = today.getMonth() - birthDate.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  return age;
}

function showToast(message, isError = false) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.classList.remove("error", "show");
  if (isError) toast.classList.add("error");
  toast.classList.add("show");

  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}

document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("userProfile"));
  if (!user) {
    showToast("No user logged in", true);
    setTimeout(() => location.href = "login.html", 2000);
    return;
  }

  // Prefill fields
  document.getElementById("name").value = user.name || "";
  document.getElementById("dob").value = user.dob || "";
  document.getElementById("age").value = user.dob ? calculateAge(user.dob) : "";
  document.getElementById("gender").value = user.gender || "";
  document.getElementById("district").value = user.district || "";
  document.getElementById("phone").value = user.phone || "";
  document.getElementById("email").value = user.email || "";
  document.getElementById("address").value = user.address || "";
  document.getElementById("pincode").value = user.pincode || "";

  // Auto age calculation
  document.getElementById("dob").addEventListener("input", function() {
    document.getElementById("age").value = calculateAge(this.value);
  });
});

document.getElementById("cancelBtn").addEventListener("click", () => {
  location.href = "profile.html";
});

document.getElementById("updateForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const user = JSON.parse(localStorage.getItem("userProfile"));
  if (!user) return showToast("No user logged in", true);

  const currentPassword = document.getElementById("currentPassword").value;
  if (currentPassword !== user.password) {
    return showToast("Current password is incorrect", true);
  }

  const updatedUser = {
    phone: user.phone,
    name: document.getElementById("name").value,
    dob: document.getElementById("dob").value,
    age: document.getElementById("age").value,
    gender: document.getElementById("gender").value,
    district: document.getElementById("district").value,
    email: document.getElementById("email").value,
    address: document.getElementById("address").value,
    pincode: document.getElementById("pincode").value,
    password: document.getElementById("newPassword").value.trim() || user.password
  };

  try {
    const res = await fetch("http://localhost:5000/update-user", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updatedUser)
    });

    const data = await res.json();

    if (!res.ok) {
      return showToast(data.error || "Update failed", true);
    }

    // Success
    localStorage.setItem("userProfile", JSON.stringify(updatedUser));
    showToast("âœ… Profile Updated Successfully!");
    setTimeout(() => location.href = "profile.html", 3000);

  } catch (err) {
    showToast("Server error. Try again later.", true);
  }
});
</script>
</body>
</html>
